-- 47120 = Arthropods taxon_id

-- Get all species of arthropods ordered by name:
-- (REMEMBER TO REMOVE ANY NAMES WITH SPECIAL CHARACTERS AT THE TOP OF THE FILE)
.headers on
.mode csv
.output all_arthropods_species.csv
SELECT DISTINCT name, taxon_id, ancestry
FROM taxa
WHERE rank = 'species'
AND '/' || ancestry || '/' LIKE '%/47120/%'
ORDER BY name;
.output stdout

-- Get all families of arthropods ordered by name:
-- (REMEMBER TO REMOVE ANY NAMES WITH SPECIAL CHARACTERS AT THE TOP OF THE FILE)
.headers on
.mode csv
.output all_arthropods_families.csv
SELECT DISTINCT name, taxon_id, ancestry
FROM taxa
WHERE rank = 'family'
AND '/' || ancestry || '/' LIKE '%/47120/%'
ORDER BY name;
.output stdout



-- For a given family, find the number of observation for each species:
.headers on
.mode csv
.output all_families_species.csv
SELECT name, t1.taxon_id, ancestry, COUNT(*) as count
FROM taxa t1
JOIN observations o1 ON t1.taxon_id = o1.taxon_id
WHERE rank = 'species'
AND '/' || ancestry || '/' LIKE '%/154351/%'
--AND o1.quality_grade = 'research'
GROUP BY name, t1.taxon_id
ORDER BY count DESC
LIMIT 1;
.output stdout


-- SELECT name, ancestry
-- FROM taxa t1
-- JOIN observations o1 ON t1.taxon_id = o1.taxon_id
-- WHERE t1.rank = 'species'
-- AND quality_grade = 'research'
-- AND '/' || t1.ancestry || '/' LIKE '%/47120/%'
-- .output stdout

-- SELECT COUNT(*)
-- FROM (
--     SELECT name, ancestry, o1.observation_uuid
--     FROM taxa t1
--     JOIN observations o1 ON t1.taxon_id = o1.taxon_id
--     WHERE t1.rank = 'species'
--     AND quality_grade = 'research'
--     AND '/' || t1.ancestry || '/' LIKE '%/47120/%'
--     AND t1.name = 'Cyzicus californicus'
-- ) AS subquery;